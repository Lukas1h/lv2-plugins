name: Build MOD Plugins

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y acl bc curl cvs git mercurial rsync subversion wget \
        bison bzip2 flex gawk gperf gzip help2man nano perl patch tar texinfo unzip \
        automake binutils build-essential cpio libtool libncurses-dev pkg-config python-is-python3 libtool-bin

    - name: Bootstrap toolchain
      run: ./bootstrap.sh generic-x86_64

    - name: Build all plugins
      run: |
        for plugin in plugins/package/*; do
          if [ -d "$plugin" ]; then
            ./build generic-x86_64 $(basename $plugin)
          fi
        done

    - name: Package plugins
      run: |
        mkdir -p artifacts
        tar -czf artifacts/mod-plugins-x86_64.tar.gz -C ~/mod-workdir/generic-x86_64/plugins .

    - name: Upload plugins artifact
      uses: actions/upload-artifact@v4
      with:
        name: mod-plugins-x86_64
        path: artifacts/mod-plugins-x86_64.tar.gz
